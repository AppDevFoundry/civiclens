You are an expert level front-end software engineer specializing in Next.js/React, TypeScript.

# Upgrade `civiclens-web` to Next.js 14 / React 18

## 1. Mission & Context

- **Repository**: `AppDevFoundry/civiclens`
- **Target submodule**: `civiclens-web` (Next.js + SWR frontend for the CivicLens product)
- **Current stack snapshot** (see `civiclens-web/package.json`):
  - `next@9.5.1`, `react@16.13.1`, `react-dom@16.13.1`
  - TypeScript 3.9, `@types/node@14`, `@types/react@16`
  - Other key deps: `axios@0.19`, `swr@0.3`, `lazysizes@5.2`, `marked@1.1`
  - No formal testing toolchain is configured yet.
- **Goal**: Upgrade this app to **Next.js 14.x**, **React 18.x**, and align every direct dependency (including testing libraries) with versions that are compatible, actively maintained, and support modern Next.js/TypeScript tooling.

## 2. High-Level Requirements

1. **Framework Upgrade**
   - Move to the latest stable `next@14` release series and enable React 18 features (Streaming, Suspense-ready data fetching).
   - Keep the existing `pages/` router for now (do not migrate to the App Router unless a blocker exists, but future-proof where feasible).
2. **Core Dependencies**
   - Upgrade `react`, `react-dom`, `typescript`, `@types/*`, `swr`, `axios`, `marked`, `lazysizes`, etc., to the latest safe majors that work with Next 14 and React 18.
   - Remove or replace packages that are obsolete under Next 14 (e.g., consider replacing `lazysizes` with `next/image` + native lazy loading if practical).
3. **Tooling & Testing**
   - Introduce or upgrade testing utilities (`jest`, `@testing-library/react`, `@testing-library/jest-dom`, `@testing-library/user-event`) and ensure they run under Node 18+.
   - Add/refresh `eslint`, `prettier` (if needed), and `next lint` integration to catch modern best practices.
4. **Configuration Updates**
   - Regenerate `next-env.d.ts`, update `tsconfig.json`, and create/update `next.config.js` to opt into SWC, turbopack compatibility, `images` config, etc.
   - Ensure `.env.local` inputs continue to work; do **not** commit secrets.
5. **Code Adjustments**
   - Refactor legacy APIs deprecated since Next 9.x (e.g., `getInitialProps`, legacy `Link` usage, custom `_app` patterns).
   - Update imports (`next/head`, `next/router`) to match the latest API, remove polyfills, and leverage React 18 patterns (e.g., `useTransition` where warranted).
6. **Documentation & Verification**
   - Update `README.md` (or add an `UPGRADE_NOTES.md`) summarizing new commands, Node requirements (>=18), and migration notes.
   - Provide a concise changelog listing key dependency jumps and breaking changes handled.

## 3. Detailed Task Breakdown

1. **Baseline Audit**
   - Inspect `pages/`, `components/`, `lib/`, and `tsconfig.json` to inventory outdated Next APIs (`getInitialProps`, custom `_document`, dynamic routes, etc.).
   - Note any direct DOM manipulations or browser-only packages (e.g., `lazysizes`) that might conflict with React 18 strict mode.
2. **Dependency Upgrade Plan**
   - Draft an upgrade matrix mapping each dependency to its target version (document rationale for major jumps).
   - Prioritize framework + React packages first, then TypeScript types, then libraries (SWR, axios, marked, etc.), then tooling.
3. **Incremental Upgrades**
   - Update `package.json` and regenerate `package-lock.json` using `npm install`.
   - Add scripts: `npm run lint`, `npm run test`, `npm run type-check` (if separated).
   - Introduce Jest config (`jest.config.ts` or `next/jest`) and setup file for RTL custom matchers.
4. **Code Refactoring**
   - Replace deprecated Next patterns (e.g., `next/image` instead of `<img>` with `lazysizes`, `Link` without child `<a>`, use `next/navigation` where applicable).
   - Ensure dynamic imports use the new API shape (no `Component.preload` hacks).
   - Verify `marked` usage is secure; consider enabling `marked.use({ mangle: false, headerIds: false })` or swapping for `@next/mdx` if necessary.
5. **TypeScript & Config**
   - Update `tsconfig.json` to Next 14 defaults (e.g., `"target": "es2017" | "es2020"`, `"module": "esnext"`, `"jsx": "preserve"`, `strict` true if feasible).
   - Confirm `next-env.d.ts` is regenerated by running `next dev` once.
   - Add/adjust `next.config.js` with `reactStrictMode`, `experimental.turbo`, `images`, and environment-specific toggles the app needs.
6. **Testing & QA**
   - Create at least a smoke test covering a representative page (e.g., home feed) using Testing Library.
   - Add utility tests for SWR hooks or helper functions in `lib/`.
   - Run `npm run lint`, `npm run type-check`, `npm run test`, and `npm run build`; capture logs for the PR.
7. **Documentation & Handoff**
   - Update `civiclens-web/README.md` with new instructions, Node version, test commands.
   - Add an `UPGRADE_NOTES.md` summarizing breaking changes handled, new dependencies, and follow-up work.
   - Provide a final PR checklist (tests run, manual QA, screenshots if needed).

## 4. Acceptance Criteria

- `npm run build` and `npm run start` succeed without warnings related to deprecated APIs.
- React 18 Strict Mode is enabled and the UI works (no double-invocation regressions).
- Testing commands exist and pass in CI (or locally) with at least one meaningful test file.
- Documentation clearly states upgrade rationale, Node version >= 18, and any manual migration steps for contributors.
- No regressions in existing RealWorld flows (auth, CRUD, pagination). Provide brief manual QA notes.

## 5. Constraints & Guardrails

- Keep work scoped to `civiclens-web`; do not modify other platform folders (Android/iOS/API) except for shared documentation references if absolutely required.
- Favor npm (lockfile already present); do not switch package managers without explicit approval.
- Do not downgrade or remove functionality tied to the RealWorld spec without a documented reason.
- Avoid introducing experimental Next features that are unstable unless necessary and well-documented.
- Ensure any new dependencies are MIT/BSD-compatible or otherwise acceptable for open-source use.

## 6. Deliverables

1. Updated `package.json` + `package-lock.json` reflecting all upgrades.
2. Code changes addressing API incompatibilities, lint/type issues, and testing setup.
3. Documentation updates (`README.md`, potential `UPGRADE_NOTES.md`) plus a short summary for PR reviewers.
4. Test/lint/build logs or notes demonstrating green runs.

## 7. Suggested Workflow

1. Create a working branch (e.g., `feature/next14-upgrade`).
2. Run `npm outdated` to capture baselines (attach to PR description).
3. Upgrade Next/React + regenerate lockfile; fix immediate type/runtime issues.
4. Layer in tooling/testing upgrades; iteratively run lint/type/test/build after each major change.
5. Replace or modernize legacy patterns discovered during refactor.
6. Perform manual QA against key flows (auth, feed, editor, profile).
7. Document findings, follow-up tasks, and submit PR with checklists + screenshots if UI changed.

## 8. Follow-Up / Nice-to-Haves (Document but Optional if Time-Constrained)

- Explore migrating media handling to `next/image`.
- Evaluate SWR vs. React Query (note trade-offs, but do not migrate unless trivial).
- Add MSW or API mocking for future test coverage.
- Set up GitHub Actions workflow (lint/test/build) if not already configured.

---

**Final instruction to the coding agent**: Use this document as your authoritative prompt. Keep communication concise, surface blockers early, and document any deviations from the plan. The upgrade is complete only when the app builds, tests, and runs cleanly on Node 18+ with Next.js 14 + React 18, with updated dependencies and documented migration notes.
